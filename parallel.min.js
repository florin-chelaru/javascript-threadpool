/**
* @license threadpool.js
* Copyright (c) 2015 Florin Chelaru
* License: MIT
*
* Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
* documentation files (the "Software"), to deal in the Software without restriction, including without limitation the
* rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
* permit persons to whom the Software is furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the
* Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
* WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
* COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
* OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
(function(){'use strict';var f=this;function h(b,c){var a=b.split("."),d=f;a[0]in d||!d.execScript||d.execScript("var "+a[0]);for(var e;a.length&&(e=a.shift());)a.length||void 0===c?d[e]?d=d[e]:d=d[e]={}:d[e]=c};function k(b){this.__id=++l;this.a=new u.Event;var c=this;Object.getOwnPropertyNames(b.prototype).forEach(function(a){var d=Object.getOwnPropertyDescriptor(b.prototype,a),e={configurable:!1,enumerable:d.enumerable};if("function"!=typeof d.value){if(e.get=function(){return new Promise(function(b,d){c.a.fire({resolve:b,reject:d,target:c,method:a,type:"get"})})},"set"in d||d.writable)e.set=function(b){return new Promise(function(d,e){c.a.fire({resolve:d,reject:e,target:c,method:a,j:[b],type:"set"})})}}else e.value=
function(){var b=u.array.fromArguments(arguments);return new Promise(function(d,e){c.a.fire({resolve:d,reject:e,target:c,method:a,j:b,type:"function"})})};Object.defineProperty(c,a,e)})}var l=-1;function m(b,c,a,d){this.threadId=b;this.action=c;this.data=a;this.error=d};function p(b,c){this.m=c;this.g=b;this.h=null;this.a=0;this.b=!0;this.o=!1;this.i={};this.c=null;this.f=new u.Event}Object.defineProperties(p.prototype,{id:{get:function(){return this.g}},isIdle:{get:function(){return this.b}},isStarted:{get:function(){return this.o}},turnedIdle:{get:function(){return this.f}}});p.prototype.start=function(){if(this.c)return this.c;this.h=new Worker(this.m);var b=this;return this.c=new Promise(function(c,a){q(b,new m(b.g,"start")).then(function(a){b.o=!0;c(a)},a)})};
p.prototype.s=function(b,c){var a=this;++this.a;this.b=!1;return new Promise(function(d,e){c=c?c.map(function(a){return a instanceof k?{__id:a.__id}:a}):void 0;q(a,new m(a.g,"call",{func:b.toString(),args:c})).then(function(b){--a.a;a.b=!a.a;d(b.data);a.b&&a.f.fire(a)},function(b){--a.a;a.b=!a.a;e(b.error);a.b&&a.f.fire(a)})})};
p.prototype.l=function(b,c){var a=this;return new Promise(function(d,e){var n=u.reflection.evaluateFullyQualifiedTypeName(b),g=new k(n);g.a.addListener(function(b){var c=b.resolve,d=b.reject,e=b.j?b.j.map(function(a){return a instanceof k?{__id:a.__id}:a}):void 0;++a.a;a.b=!1;q(a,new m(a.g,"callShared",{target:b.target.__id,method:b.method,type:b.type,args:e})).then(function(b){--a.a;a.b=!a.a;c(b.data);a.b&&a.f.fire(a)},function(b){--a.a;a.b=!a.a;d(b.error);a.b&&a.f.fire(a)})});a.i[g.__id]=g;c=c?
c.map(function(a){return a instanceof k?{__id:a.__id}:a}):void 0;++a.a;a.b=!1;q(a,new m(a.g,"createShared",{id:g.__id,type:b,args:c})).then(function(){--a.a;a.b=!a.a;d(g);a.b&&a.f.fire(a)},function(b){--a.a;a.b=!a.a;e(b);a.b&&a.f.fire(a)})})};function q(b,c){return new Promise(function(a,d){var e=new MessageChannel;e.port1.onmessage=function(b){b=u.reflection.wrap(b.data,m);b.error?d(b):a(b)};b.h.postMessage(c,[e.port2])})};function r(b,c){u.Exception.apply(this,arguments);this.name="ParallelException"}(function(){var b=u.Exception;function c(){}c.prototype=b.prototype;r.c=b.prototype;r.prototype=new c;r.prototype.constructor=r;r.a=function(a,c,e){for(var n=Array(arguments.length-2),g=2;g<arguments.length;g++)n[g-2]=arguments[g];return b.prototype[c].apply(a,n)}})();function t(b,c){if(0>=b)throw new r("Invalid ThreadPool parameter maxThreads = "+b+"; minimum is 1");this.l=b;this.i=c;this.a=[];this.a.push(new p(0,this.i));this.a[0].turnedIdle.addListener(this.h,this);this.a[0].start();this.c=[]}function v(b){for(var c=null,a=0;a<b.a.length;++a)if(b.a[a].isIdle){if(b.a[a].isStarted)return b.a[a];c=b.a[a]}return null!==c?c:b.a.length<b.l?(c=new p(b.a.length,b.i),c.turnedIdle.addListener(b.h,b),b.a.push(c),c.start(),c):null}
t.prototype.m=function(b){var c=this,a=v(c);return null!==a?b.call(null,a):new Promise(function(a,e){c.c.push({v:b,resolve:a,reject:e})})};t.prototype.h=function(b){if(0!=this.c.length){var c=this.c.shift(),a=c.resolve,d=c.reject;c.v.call(null,b).then(a,d)}};h("parallel.SharedObject",k);h("parallel.ThreadPool",t);t.prototype.queue=t.prototype.m;h("parallel.ThreadProxy",p);p.prototype.start=p.prototype.start;p.prototype.run=p.prototype.s;p.prototype.createShared=p.prototype.l;}).call(this); //# sourceMappingURL=parallel.min.js.map
