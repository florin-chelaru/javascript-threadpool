/**
* @license threadpool.js
* Copyright (c) 2015 Florin Chelaru
* License: MIT
*
* Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
* documentation files (the "Software"), to deal in the Software without restriction, including without limitation the
* rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
* permit persons to whom the Software is furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the
* Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
* WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
* COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
* OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
(function(){'use strict';var f=this;function h(a,b){var c=a.split("."),d=f;c[0]in d||!d.execScript||d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||void 0===b?d[e]?d=d[e]:d=d[e]={}:d[e]=b};function l(a,b,c,d){this.threadId=a;this.action=b;this.data=c;this.error=d};function m(a){this.__id=++n;this.h=new u.Event;var b=this;Object.getOwnPropertyNames(a.prototype).forEach(function(c){var d=Object.getOwnPropertyDescriptor(a.prototype,c),e={configurable:!1,enumerable:d.enumerable};if("function"!=typeof d.value){if(e.get=function(){return new Promise(function(a,d){b.h.fire({resolve:a,reject:d,target:b,method:c,type:"get"})})},"set"in d||d.writable)e.set=function(a){return new Promise(function(d,k){b.h.fire({resolve:d,reject:k,target:b,method:c,i:[a],type:"set"})})}}else e.value=
function(){var a=u.array.fromArguments(arguments);return new Promise(function(d,k){b.h.fire({resolve:d,reject:k,target:b,method:c,i:a,type:"function"})})};Object.defineProperty(b,c,e)})}var n=-1;function p(a){return{__id:a.__id}};function r(a,b){u.Exception.apply(this,arguments);this.name="ParallelException"}(function(){var a=u.Exception;function b(){}b.prototype=a.prototype;r.b=a.prototype;r.prototype=new b;r.prototype.constructor=r;r.a=function(b,d,e){for(var q=Array(arguments.length-2),g=2;g<arguments.length;g++)q[g-2]=arguments[g];return a.prototype[d].apply(b,q)}})();function t(a,b){this.o=b;this.c=a;this.f=null;this.g=0;this.j=!0;this.s=!1;this.l={};this.b=this.a=null;this.v=new u.Event}Object.defineProperties(t.prototype,{id:{get:function(){return this.c}},isIdle:{get:function(){return this.j}},isStarted:{get:function(){return this.s}},turnedIdle:{get:function(){return this.v}}});
t.prototype.start=function(){if(this.a)return this.a;this.f=new Worker(this.o);var a=this;return this.a=new Promise(function(b,c){v(a,new l(a.c,"start")).then(function(c){a.s=!0;b(c)},c)})};t.prototype.stop=function(){function a(a){b.f.terminate();b.f=null;b.a=null;b.b=null;a()}if(!this.f)return Promise.resolve();if(this.b)return this.b;var b=this;return this.b=new Promise(function(c){b.a.then(function(){return v(b,new l(b.c,"stop"))},function(){a(c)}).then(function(){a(c)},function(){a(c)})})};
t.prototype.w=function(a,b){var c=this;b=u.array.fromArguments(arguments).slice(1);return new Promise(function(d,e){b=b?b.map(function(a){return a instanceof m?p(a):a}):void 0;v(c,new l(c.c,"call",{func:a.toString(),args:b})).then(function(a){d(a.data)},function(a){e(a.error)})})};
t.prototype.m=function(a,b){var c=this;b=u.array.fromArguments(arguments).slice(1);return new Promise(function(d,e){var q=u.reflection.evaluateFullyQualifiedTypeName(a),g=new m(q);b=b?b.map(function(a){return a instanceof m?p(a):a}):void 0;v(c,new l(c.c,"createShared",{id:g.__id,type:a,args:b})).then(function(){g.h.addListener(function(a){var b=a.resolve,d=a.reject,e=a.i?a.i.map(function(a){return a instanceof m?p(a):a}):void 0;v(c,new l(c.c,"callShared",{target:a.target.__id,method:a.method,type:a.type,
args:e})).then(function(a){b(a.data)},function(a){d(a.error)})});c.l[g.__id]=g;d(g)},e)})};
t.prototype.B=function(a,b,c){var d=this;c=u.array.fromArguments(arguments);return new Promise(function(a,b){try{if(0==c.length||0!=c.length%2)b("Invalid arguments");else{var g=u.array.range(Math.floor(c.length/2)),k=g.map(function(a){if(c[2*a]instanceof m)return null;a=u.reflection.evaluateFullyQualifiedTypeName(c[2*a+1]);return new m(a)}),x=g.map(function(a){return{id:c[2*a]instanceof m?c[2*a].__id:k[a].__id,object:c[2*a]instanceof m?void 0:c[2*a],type:c[2*a+1]}});v(d,new l(d.c,"swap",x)).then(function(b){k=
b.data.map(function(a,b){if(k[b]instanceof m){var e=k[b];e.h.addListener(function(a){var b=a.resolve,c=a.reject,e=a.i?a.i.map(function(a){return a instanceof m?p(a):a}):void 0;v(d,new l(d.c,"callShared",{target:a.target.__id,method:a.method,type:a.type,args:e})).then(function(a){b(a.data)},function(a){c(a.error)})});return d.l[e.__id]=e}return u.reflection.wrap(a,u.reflection.evaluateFullyQualifiedTypeName(c[2*b+1]))});a(1==k.length?k[0]:k)},b)}}catch(y){b(y)}})};
function v(a,b){return new Promise(function(c,d){var e=new MessageChannel;e.port1.onmessage=function(b){b=u.reflection.wrap(b.data,l);b.error?d(b):c(b);--a.g;a.j=!a.g;a.j&&a.v.fire(a)};++a.g;a.j=!1;a.f.postMessage(b,[e.port2])})};function w(a,b){if(0>=a)throw new r("Invalid ThreadPool parameter maxThreads = "+a+"; minimum is 1");this.l=a;this.g=b;this.a=[];this.a.push(new t(0,this.g));this.a[0].turnedIdle.addListener(this.f,this);this.a[0].start();this.b=[]}function z(a){for(var b=null,c=0;c<a.a.length;++c)if(a.a[c].isIdle){if(a.a[c].isStarted)return a.a[c];b=a.a[c]}return null!==b?b:a.a.length<a.l?(b=new t(a.a.length,a.g),b.turnedIdle.addListener(a.f,a),a.a.push(b),b.start(),b):null}
w.prototype.m=function(a){var b=this,c=z(b);return null!==c?a.call(null,c):new Promise(function(c,e){b.b.push({A:a,resolve:c,reject:e})})};w.prototype.o=function(){return u.async.each(this.a,function(a){return a.stop()})};w.prototype.f=function(a){if(0!=this.b.length){var b=this.b.shift(),c=b.resolve,d=b.reject;b.A.call(null,a).then(c,d)}};h("parallel.SharedObject",m);h("parallel.ThreadPool",w);w.prototype.queue=w.prototype.m;w.prototype.stopAll=w.prototype.o;h("parallel.ThreadProxy",t);t.prototype.start=t.prototype.start;t.prototype.stop=t.prototype.stop;t.prototype.run=t.prototype.w;t.prototype.createShared=t.prototype.m;t.prototype.swap=t.prototype.B;}).call(this); //# sourceMappingURL=parallel.min.js.map
